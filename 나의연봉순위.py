import streamlit as st
import pandas as pd
import re

# Streamlit í˜ì´ì§€ ì„¤ì •: ë¸Œë¼ìš°ì € íƒ­ ì œëª©ê³¼ ì•„ì´ì½˜ì„ ì„¤ì •í•©ë‹ˆë‹¤.
st.set_page_config(
    page_title="ë‚˜ì˜ ê·¼ë¡œì†Œë“ ìˆœìœ„ ë¶„ì„",
    page_icon="ğŸ“Š",
    layout="centered" # í˜ì´ì§€ ë ˆì´ì•„ì›ƒì„ ì¤‘ì•™ ì •ë ¬ë¡œ ì„¤ì • (ê¸°ë³¸ê°’ì€ 'centered' ë˜ëŠ” 'wide' ì„ íƒ ê°€ëŠ¥)
)

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ë° ì „ì²˜ë¦¬ í•¨ìˆ˜
@st.cache_data
def load_data():
    df = pd.read_csv("êµ­ì„¸ì²­_ê·¼ë¡œì†Œë“ ë°±ë¶„ìœ„(ì²œë¶„ìœ„) ìë£Œ_20241231.csv", encoding='cp949')
    df = df.dropna()

    df["ì¸ì›"] = df["ì¸ì›"].astype(float)
    df["ê·¼ë¡œì†Œë“ê¸ˆì•¡"] = df["ê·¼ë¡œì†Œë“ê¸ˆì•¡"].astype(float)

    # 1ì¸ë‹¹ ê·¼ë¡œì†Œë“ê¸ˆì•¡ ê³„ì‚° (ì–µ ì› -> ë§Œì›)
    df['ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ì–µì›'] = df.apply(
        lambda row: row['ê·¼ë¡œì†Œë“ê¸ˆì•¡'] / row['ì¸ì›'] if row['ì¸ì›'] > 0 else 0,
        axis=1
    )
    df['ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›'] = df['ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ì–µì›'] * 1e4

    # 'êµ¬ë¶„' ì»¬ëŸ¼ ì •ë ¬ì„ ìœ„í•œ ì„ì‹œ ìˆ«ì ì»¬ëŸ¼ ìƒì„±
    def get_percentile_value(s):
        match = re.search(r'(\d+\.?\d*)', s)
        if match:
            value = float(match.group(1))
            if 'ìƒìœ„' in s:
                return 100 - value
            elif 'í•˜ìœ„' in s:
                return value
            else:
                return value / 1000 * 100
        return -1

    df['_sort_order'] = df['êµ¬ë¶„'].apply(get_percentile_value)

    # '1ì¸ë‹¹ ê·¼ë¡œì†Œë“ê¸ˆì•¡_ë§Œì›' ë° ë°±ë¶„ìœ„ ìˆœì„œë¡œ ì •ë ¬
    df_sorted = df.sort_values(
        by=["ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›", '_sort_order'],
        ascending=True
    ).reset_index(drop=True)

    df_sorted = df_sorted.drop(columns=['_sort_order'])
    return df_sorted

# ë°ì´í„° ë¡œë”©
df = load_data()

# --- ì•± UI ì‹œì‘ ---

# ë©”ì¸ ì œëª© ë° ì„¤ëª…
st.title("ğŸ“Š ë‚˜ì˜ ê·¼ë¡œì†Œë“ ìˆœìœ„ëŠ”?")
st.markdown("êµ­ì„¸ì²­ [ê·¼ë¡œì†Œë“ ë°±ë¶„ìœ„(ì²œë¶„ìœ„)] í†µê³„ ê¸°ì¤€ì´ë©°, **1ì¸ë‹¹ ê·¼ë¡œì†Œë“ê¸ˆì•¡**ì„ ê¸°ì¤€ìœ¼ë¡œ ìˆœìœ„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.")
st.markdown("---") # ì‹œê°ì  êµ¬ë¶„ì„ 

# ì‚¬ìš©ì ì…ë ¥: ì‚¬ì´ë“œë°”ë¡œ ì´ë™
with st.sidebar:
    st.header("ì…ë ¥í•˜ê¸° âœï¸")
    st.markdown("ë‹¹ì‹ ì˜ ì—°ê°„ **ê·¼ë¡œì†Œë“ê¸ˆì•¡**ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.")
    user_income = st.number_input(
        "ê·¼ë¡œì†Œë“ê¸ˆì•¡ (ë§Œì›)",
        min_value=0,
        value=0,
        step=100,
        help="ì„¸ê¸ˆ ë° ê³µì œ ì „ì˜ ì´ ê¸‰ì—¬ê°€ ì•„ë‹Œ, ê·¼ë¡œì†Œë“ê³µì œ ë“±ì„ ë§ˆì¹œ í›„ì˜ ê·¼ë¡œì†Œë“ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”."
    )
    st.markdown("---")
    st.caption("ë³¸ ì•±ì€ êµ­ì„¸ì²­ ê³µê°œ í†µê³„ ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§Œë“¤ì–´ì¡ŒìŠµë‹ˆë‹¤.")

# ë©”ì¸ ì½˜í…ì¸  ì˜ì—­
if user_income > 0:
    user_income_mw = user_income

    min_income_data = df["ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›"].min()
    max_income_data = df["ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›"].max()

    # ê²°ê³¼ ë©”ì‹œì§€ í‘œì‹œ
    st.subheader("â­ ë‹¹ì‹ ì˜ ì†Œë“ ìˆœìœ„ ê²°ê³¼")

    # st.metricì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ì ì†Œë“ ê°•ì¡°
    st.metric(label="âœ… ë‹¹ì‹ ì˜ ê·¼ë¡œì†Œë“ê¸ˆì•¡", value=f"{user_income_mw:,.0f} ë§Œì›")

    # í†µê³„ ë²”ìœ„ ë°–ì˜ ê²½ìš°
    if user_income_mw < min_income_data:
        st.info(
            f"ğŸ“‰ ë‹¹ì‹ ì˜ ê·¼ë¡œì†Œë“ê¸ˆì•¡({user_income_mw:,.0f} ë§Œì›)ì€ í†µê³„ ë°ì´í„° ë‚´ ê°€ì¥ ë‚®ì€ êµ¬ê°„ì¸ "
            f"**{df['êµ¬ë¶„'].iloc[0]}** ì˜ 1ì¸ë‹¹ ê·¼ë¡œì†Œë“ê¸ˆì•¡({min_income_data:,.0f} ë§Œì›)ë³´ë‹¤ë„ ë‚®ìŠµë‹ˆë‹¤."
        )
    elif user_income_mw > max_income_data:
        st.info(
            f"ğŸ“ˆ ë‹¹ì‹ ì˜ ê·¼ë¡œì†Œë“ê¸ˆì•¡({user_income_mw:,.0f} ë§Œì›)ì€ í†µê³„ ë°ì´í„° ë‚´ ê°€ì¥ ë†’ì€ êµ¬ê°„ì¸ "
            f"**{df['êµ¬ë¶„'].iloc[-1]}** ì˜ 1ì¸ë‹¹ ê·¼ë¡œì†Œë“ê¸ˆì•¡({max_income_data:,.0f} ë§Œì›)ë³´ë‹¤ë„ ë†’ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì€ í†µê³„ìƒ ìµœìƒìœ„ê¶Œì— ì†í•©ë‹ˆë‹¤!"
        )
    else:
        # í†µê³„ ë²”ìœ„ ë‚´ì˜ ê²½ìš°
        upper_bound_indices = df[df["ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›"] >= user_income_mw].index
        upper_bound_row = df.loc[upper_bound_indices[0]]

        lower_bound_indices = df[df["ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›"] < user_income_mw].index
        
        if not lower_bound_indices.empty:
            lower_bound_row = df.loc[lower_bound_indices[-1]]
            
            st.success(
                f"ğŸ‰ êµ­ì„¸ì²­ í†µê³„ ê¸°ì¤€, ë‹¹ì‹ ì˜ ê·¼ë¡œì†Œë“ê¸ˆì•¡ì€ "
                f"**{lower_bound_row['êµ¬ë¶„']}** ì˜ ì†Œë“ê³¼ **{upper_bound_row['êµ¬ë¶„']}** ì˜ ì†Œë“ ì‚¬ì´ì— í•´ë‹¹í•©ë‹ˆë‹¤!"
            )
            st.write(f"ì´ëŠ” ë‹¹ì‹ ì´ ì ì–´ë„ **{lower_bound_row['êµ¬ë¶„']}** ì— í•´ë‹¹í•˜ëŠ” 1ì¸ë‹¹ ê·¼ë¡œì†Œë“ê¸ˆì•¡ë³´ë‹¤ëŠ” ë” ë§ì€ ìˆ˜ì…ì„ ì˜¬ë¦¬ê³  ìˆìŒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.")

            # ê´€ë ¨ ì†Œë“ êµ¬ê°„ ì •ë³´st.columnsë¡œ ë°°ì¹˜
            col1, col2 = st.columns(2)
            with col1:
                st.metric(label=f"â¬‡ï¸ {lower_bound_row['êµ¬ë¶„']} (í•˜í•œ)", value=f"{lower_bound_row['ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›']:,.0f} ë§Œì›")
            with col2:
                st.metric(label=f"â¬†ï¸ {upper_bound_row['êµ¬ë¶„']} (ìƒí•œ)", value=f"{upper_bound_row['ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›']:,.0f} ë§Œì›")
            
        else:
            # ì‚¬ìš©ìì˜ ì—°ë´‰ì´ í†µê³„ ë°ì´í„°ì˜ ì²« ë²ˆì§¸ êµ¬ê°„ì— ì†í•˜ê±°ë‚˜ ê·¸ë³´ë‹¤ ì•½ê°„ ë†’ì€ ê²½ìš°
            st.success(
                f"ğŸ‰ ë‹¹ì‹ ì˜ ê·¼ë¡œì†Œë“ê¸ˆì•¡ì€ êµ­ì„¸ì²­ í†µê³„ ê¸°ì¤€ "
                f"**{upper_bound_row['êµ¬ë¶„']}** ì˜ 1ì¸ë‹¹ ê·¼ë¡œì†Œë“ê¸ˆì•¡({upper_bound_row['ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›']:,.0f} ë§Œì›)ì— í•´ë‹¹í•˜ê±°ë‚˜ ê·¸ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤."
            )
            st.metric(label=f"â¬†ï¸ {upper_bound_row['êµ¬ë¶„']} (ìƒí•œ)", value=f"{upper_bound_row['ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›']:,.0f} ë§Œì›")

# ì‚¬ìš©ì ì…ë ¥ì´ 0ì´ê±°ë‚˜ ì•„ì§ ì…ë ¥í•˜ì§€ ì•Šì€ ê²½ìš° ì•ˆë‚´ ë©”ì‹œì§€
else:
    st.info("ğŸ‘ˆ ì™¼ìª½ ì‚¬ì´ë“œë°”ì— ì—°ê°„ ê·¼ë¡œì†Œë“ê¸ˆì•¡ì„ ì…ë ¥í•˜ì—¬ ë‹¹ì‹ ì˜ ìˆœìœ„ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”! (ì˜ˆ: 5000)")

st.markdown("---")

# í†µê³„ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°: st.expanderë¡œ ê°ì‹¸ ê¹”ë”í•˜ê²Œ ì •ë¦¬
with st.expander("ğŸ“Š í†µê³„ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (í´ë¦­í•˜ì—¬ í¼ì¹˜ê¸°/ì ‘ê¸°)"):
    st.markdown("êµ­ì„¸ì²­ì—ì„œ ì œê³µí•˜ëŠ” ì›ë³¸ ë°ì´í„°ì˜ ì¼ë¶€ì…ë‹ˆë‹¤. 'ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›' ì»¬ëŸ¼ì„ ì°¸ê³ í•˜ì„¸ìš”.")
    st.dataframe(df[['êµ¬ë¶„', 'ì¸ì›', 'ê·¼ë¡œì†Œë“ê¸ˆì•¡', 'ê·¼ë¡œì†Œë“ê¸ˆì•¡_1ì¸ë‹¹_ë§Œì›']].head(20)) # ë” ë§ì€ í–‰ì„ ë³´ì—¬ì¤„ ìˆ˜ ìˆë„ë¡ head(20)ìœ¼ë¡œ ë³€ê²½

st.markdown("---")
st.caption("Â© 2025 ê·¼ë¡œì†Œë“ ìˆœìœ„ ë¶„ì„ê¸°. ë°ì´í„° ì¶œì²˜: êµ­ì„¸ì²­.")
